<?phpclass JSApiTicket{    //公众号的信息    private $wx = array();    public function __construct()    {        $this->wx['appid'] = C('appid');        $this->wx['appsecret'] = C('appsecret');        $this->wx['token'] = C('token');    }    public function getSignPackage()    {        $jsapiTicket = $this->getJSApiTicket();        $url = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";        $timestamp = time();        $nonceStr = $this->createNonceStr();        // 这里参数的顺序要按照 key 值 ASCII 码升序排序        $string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";        $signature = sha1($string);        $signPackage = array(            "appId"     => $this->wx['appid'],            "nonceStr"  => $nonceStr,            "timestamp" => $timestamp,            "url"       => $url,            "signature" => $signature,            "rawString" => $string        );        return $signPackage;    }    private function createNonceStr($length = 16) {        $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";        $str = "";        for ($i = 0; $i < $length; $i++) {            $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);        }        return $str;    }    private function getJSApiTicket()    {        $nowTime = date('y-m-d H:i:s',time());        $refreshDBJSApiTicket = 0;        $memo = "这是备注";        if(true){            $memo = "初始化：".C('jsapi_ticket').';';            if(C('jsapi_ticket')){                $dbJSApiTicketCreatetime = C('jsapi_ticket_createtime');                $diff= strtotime($nowTime)-strtotime($dbJSApiTicketCreatetime);                if($diff>6800){                    $info = $this->getJSApiTicketInfoFromServer();                    $memo = $memo."时间差：".$diff.'';                    $result = $info['ticket'];                    $expires_in = $info['expires_in'];                    $refreshDBJSApiTicket = 1;                }                $returnResult = C('jsapi_ticket');            }else{                $info = $this->getJSApiTicketInfoFromServer();                $memo =  $memo.'新结果：'.$info['ticket'];                $returnResult = $info['ticket'];                $result = $info['ticket'];                $expires_in = $info['expires_in'];                $refreshDBJSApiTicket = 2;            }        }else {            $dbJsapiTicketRecord = M('jsapi_ticket') ->order('id desc')->limit(0,1)->find();            if ($dbJsapiTicketRecord) {                $dbJSApiTicket = $dbJsapiTicketRecord['jsapi_ticket'];                $dbJSApiTicketCreatetime = $dbJsapiTicketRecord['createtime'];                $diff = strtotime($nowTime) - strtotime($dbJSApiTicketCreatetime);                if ($diff > 6800) {                    $result = $this->getJSApiTicketFromServer();                    $refreshDBJSApiTicket = 1;                } else {                    $result = $dbJSApiTicket;                }            } else {                $result = $this->getJSApiTicketFromServer();                $refreshDBJSApiTicket = 2;            }        }        if($refreshDBJSApiTicket > 0 )        {            $data['token']=$this->wx['token'];            $data['jsapi_ticket'] = $result;            $data['createtime'] = $nowTime;            $data['expires_in'] = $expires_in;            $data['memo'] = $memo;            M('jsapi_ticket')->add($data);            import('ORG.Setting');            $Setting = new \Setting();            $Setting->updateJSApiTicket($data);        }        return $returnResult;    }    //从服务器获取    private function getJSApiTicketInfoFromServer()    {        import('ORG.Weixin.AccessToken');        $accessTokenUtil = new \AccessToken();        $access_token = $accessTokenUtil->getAccessToken();        $jurl = "https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=$access_token&type=jsapi";        $j= json_decode($this->curl_file_get_contents($jurl), true);        return $j;    }    private function getJSApiTicketFromServer()    {        $j= $this->getJSApiTicketInfoFromServer();        $jsapiTicket = $j['ticket'];        return $jsapiTicket;    }    private function curl_file_get_contents($durl)    {        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $durl);        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // 获取数据返回        curl_setopt($ch, CURLOPT_BINARYTRANSFER, true); // 在启用 CURLOPT_RETURNTRANSFER 时候将获取数据返回        $r = curl_exec($ch);        curl_close($ch);        return $r;    }}?>