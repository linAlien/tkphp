<?phpclass WechatUserInfo{    //公众号的信息    private $wx = array();    public function __construct()    {        $this->wx['appid'] = C('appid');        $this->wx['appsecret'] = C('appsecret');        $this->wx['token'] = C('token');    }    //根据openid获取用户的信息    //"subscribe": 1,    //"openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",    //"nickname": "Band",    //"sex": 1,    //"language": "zh_CN",    //"city": "广州",    //"province": "广东",    //"country": "中国",    //"headimgurl":    "http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0",    //"subscribe_time": 1382694957,    //"unionid": " o6_bmasdasdsad6_2sgVt7hMZOPfL"    //"remark": "",    //"groupid": 0    public function getUserInfo($userOpenid)    {        import('ORG.Weixin.AccessToken');        $accessTokenUtil = new \AccessToken();        $access_token = $accessTokenUtil->getAccessToken();        //简单鉴权后再获取个人信息        $infourl = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=$access_token&openid=" . $userOpenid . "&lang=zh_CN";        $info = json_decode($this->curl_file_get_contents($infourl), true);        return $info;    }    //是否已经关注    public function getSubscribe($openId)    {        import('ORG.Weixin.AccessToken');        $accessTokenUtil = new \AccessToken();        $access_token = $accessTokenUtil->getAccessToken();        $infourl = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=$access_token&openid=".$openId."&lang=zh_CN";        $unifo = json_decode($this->curl_file_get_contents($infourl), true);        return $unifo['subscribe'];    }    public function getOauth2()    {        if($_GET['code']){            $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=".$this->wx['appid']."&secret=".$this->wx['appsecret']."&code=" . $_GET['code'] . "&grant_type=authorization_code";            $data = json_decode($this->curl_file_get_contents($url), true);            return $data;        }        else{            $url =  $this->get_url();            $shareurl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=".$this->wx['appid']."&redirect_uri=" . urlencode($url) . "&response_type=code&scope=snsapi_base&state=1#wechat_redirect";            Redirect($shareurl);            return null;        }    }    public function getOpenid()    {        $data = $this->getOauth2();        return $data['openid'];    }    public function getOauth2AccessToken()    {        $data = $this->getOauth2();        return $data['access_token'];    }    function get_url() {        $sys_protocal = isset($_SERVER['SERVER_PORT']) && $_SERVER['SERVER_PORT'] == '443' ? 'https://' : 'http://';        $php_self = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];        $path_info = isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : '';        $relate_url = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : $php_self.(isset($_SERVER['QUERY_STRING']) ? '?'.$_SERVER['QUERY_STRING'] : $path_info);        return $sys_protocal.(isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : '').$relate_url;    }    function curl_file_get_contents($durl)    {        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $durl);        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // 获取数据返回        curl_setopt($ch, CURLOPT_BINARYTRANSFER, true); // 在启用 CURLOPT_RETURNTRANSFER 时候将获取数据返回        $r = curl_exec($ch);        curl_close($ch);        return $r;    }}?>