<?phpclass AccessToken{    //公众号的信息    private $wx = array();    public function __construct()    {        $this->wx['appid'] = C('appid');        $this->wx['appsecret'] = C('appsecret');        $this->wx['token'] = C('token');    }    //从服务器获取    private function getAccessTokenInfoFromServer()    {        $aurl = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=".$this->wx['appid']."&secret=".$this->wx['appsecret'];        $a = $this->curl_file_get_contents($aurl);        $at = json_decode($a, true);        return $at;    }    private function getAccessTokenFromServer()    {        $info = $this->getAccessTokenInfoFromServer();        return $info['access_token'];    }    //定时从服务器刷新    public function getAccessToken(){        $nowTime = date('y-m-d H:i:s',time());        $refreshDBAccessToken = 0;        $memo = "这是备注";        if(true)        {            $memo = "初始化：".C('access_token').';';            if(C('access_token')){                $dbAccessTokenCreatetime = C('createtime');                $diff= strtotime($nowTime)-strtotime($dbAccessTokenCreatetime);                if($diff>6800){                    $info = $this->getAccessTokenInfoFromServer();                    $memo = $memo."时间差：".$diff.'';                    $result = $info['access_token'];                    $expires_in = $info['expires_in'];                    $refreshDBAccessToken = 1;                }                $returnResult = C('access_token');            }else{                $info = $this->getAccessTokenInfoFromServer();                $memo =  $memo.'新结果：'.$info['access_token'];                $returnResult = $info['access_token'];                $result = $info['access_token'];                $expires_in = $info['expires_in'];                $refreshDBAccessToken = 2;            }        }        else        {            $dbAccessTokenRecord = M('access_token')->order('id desc')->limit(0,1)->find();            if($dbAccessTokenRecord){                $dbAccessToken = $dbAccessTokenRecord['access_token'];                $dbExpires_in = $dbAccessTokenRecord['expires_in'];                $dbAccessTokenCreatetime = $dbAccessTokenRecord['createtime'];                $diff= strtotime($nowTime)-strtotime($dbAccessTokenCreatetime);                if($diff>6800){                    $info = $this->getAccessTokenInfoFromServer();                    $returnResult = $info['access_token'];                    $result = $info['access_token'];                    $expires_in = $info['expires_in'];                    $refreshDBAccessToken = 1;                }                else                {                    $returnResult = $dbAccessToken;                    $result = $dbAccessToken;                    $expires_in = $dbExpires_in;                }            }            else            {                $info = $this->getAccessTokenInfoFromServer();                $result = $info['access_token'];                $expires_in = $info['expires_in'];                $refreshDBAccessToken = 2;            }        }        if($refreshDBAccessToken >0 )        {            $data['token']=$this->wx['token'];            $data['access_token'] = $result;            $data['createtime'] = $nowTime;            $data['expires_in'] = $expires_in;            $data['memo'] = $memo;            M('access_token')->add($data);            import('ORG.Setting');            $Setting = new \Setting();            $Setting->updateAccessToken($data);        }        return $returnResult;    }    private function curl_file_get_contents($durl)    {        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $durl);        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // 获取数据返回        curl_setopt($ch, CURLOPT_BINARYTRANSFER, true); // 在启用 CURLOPT_RETURNTRANSFER 时候将获取数据返回        $r = curl_exec($ch);        curl_close($ch);        return $r;    }}?>